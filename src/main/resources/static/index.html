<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>规则配置页面-简易版</title>
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <style>
        body {
            margin: 10px;
        }
    </style>
</head>
</head>
<body>
<div class="layui-card-header">
    <blockquote class="layui-elem-quote">简单规则配置</blockquote>
</div>

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>添加条件</legend>
</fieldset>

<div class="layui-form-item">
    <label class="layui-form-label">条件名称：</label>
    <div class="layui-input-inline">
        <input type="text" id="conditionName" name="conditionName" lay-verify="title" autocomplete="off"
               class="layui-input">
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">模板名称：</label>
    <div class="layui-input-block">
        <input type="text" id="templateName" name="templateName" lay-verify="title" autocomplete="off"
               value="com.example.rule.template.RuleTemplate" class="layui-input">
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">模板方法：</label>
    <div class="layui-input-inline">
        <input type="text" id="templateMethodName" name="templateMethodName" lay-verify="title"
               autocomplete="off" value="rule" class="layui-input">
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">添加模板字段类型：</label>
    <div class="layui-input-inline">
        <input type="text" id="fieldType" name="fieldType" lay-verify="title"
               autocomplete="off" value="" class="layui-input">
    </div>
</div>
<div class="layui-form-item">
    <label class="layui-form-label">方法参数：</label>
    <div class="layui-input-block">
        <input type="text" id="paramsType" name="paramsType" lay-verify="title" autocomplete="off"
               value="com.example.rule.entity.dto.RuleTest" class="layui-input">
    </div>
</div>
<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">判断内容：</label>
    <div class="layui-input-block">
        <input type="text" id="judgeContent" name="judgeContent" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>
<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">前置内容：</label>
    <div class="layui-input-block">
        <input type="text" id="preContent" name="preContent" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>

<div class="layui-form-item layui-form layui-inline"> <!--一个表单模块-->
    <label class="layui-form-label">依赖jar包：</label>
    <div class="layui-input-inline">
        <input type="file" id="file" name="file" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>

<div id="conditionBtn" class="layui-form-item" style="margin-left: 3.125rem;">
    <button class="layui-btn" onclick="condition();">条件提交</button>
</div>

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>添加规则</legend>
</fieldset>

<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">模板名称：</label>
    <div class="layui-input-block">
        <input type="text" id="templateName2" name="templateName2" lay-verify="title"
               autocomplete="off"
               value="com.example.rule.template.RuleTemplate" class="layui-input">
    </div>
</div>
<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">规则名称：</label>
    <div class="layui-input-inline">
        <input type="text" id="ruleName" name="ruleName" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>
<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">模板方法：</label>
    <div class="layui-input-inline">
        <input type="text" id="templateMethodName2" name="templateMethodName2" lay-verify="title"
               autocomplete="off" value="rule" class="layui-input">
    </div>
</div>

<div class="layui-form-item "> <!--一个表单模块-->
    <label class="layui-form-label">组合条件：</label>
    <div class="layui-input-block">
        <div id="conditionSelect" class="xm-select-demo"></div>
    </div>
</div>


<div class="layui-form-item ">
    <label class="layui-form-label">返回类型：</label>
    <div class="layui-input-inline">
        <input type="text" id="returnType" name="returnType" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>
<div class="layui-form-item ">
    <label class="layui-form-label">命中条件数：</label>
    <div class="layui-input-inline">
        <input type="text" id="hitCount" name="hitCount" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>
<div class="layui-form-item ">
    <label class="layui-form-label">命中后操作内容：</label>
    <div class="layui-input-block">
        <input type="text" id="hitContent" name="hitContent" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>

<div id="layerBtn" class="layui-form-item" style="margin-left: 3.125rem;">
    <button class="layui-btn" onclick="addRule();">规则提交</button>
</div>


<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>执行规则</legend>
</fieldset>

<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">规则方法：</label>
    <div class="layui-input-inline">
        <input type="text" id="templateMethodName3" name="templateMethodName3" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>
<div class="layui-form-item"> <!--一个表单模块-->
    <label class="layui-form-label">规则名称：</label>
    <div class="layui-input-inline">
        <input type="text" id="ruleName2" name="ruleName2" lay-verify="title"
               autocomplete="off" class="layui-input">
    </div>
</div>
<div id="runParams">
    <div class="layui-form-item"> <!--一个表单模块-->
        <label class="layui-form-label">执行规则参数类型：</label>
        <div class="layui-input-inline">
            <input type="text" id="runParamsType1" name="runParamsType1" lay-verify="title"
                   autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label">执行规则参数值：</label>
        <div class="layui-input-inline">
            <input type="text" id="runParamsValue1" name="runParamsValue1" lay-verify="title"
                   autocomplete="off" class="layui-input">
        </div>
    </div>
</div>

<div class="layui-form-item">
    <div class="layui-inline">
        <label class="layui-form-label"></label>
        <div class="layui-inline">
            <input type='button' class="layui-btn layui-btn-sm layui-btn-primary" id="add" value="+ 添加执行规则参数"
                   onclick="addInput();"/>
        </div>
    </div>
</div>
<div id="ruleRun" class="layui-form-item" style="margin-left: 3.125rem;">
    <button class="layui-btn" onclick="ruleRun();">规则执行</button>
</div>


<!--js部分-->
<script src="/layui/layui.js"></script>
<script src="/select.js"></script>
<script>
    var lastSize = 1;
    layui.use(['jquery', 'layer'], function () {
        var $ = layui.jquery;
        $.ajax({
            url: "/rule/findCondition",
            type: "POST",
            data: {},
            contentType: "application/json;charset=utf-8", //必须
            success: function (data) {
                if (data.status == 10000) {
                    var list = data.data;
                    var conditionList = new Array();
                    for (i = 0; i < list.length; i++) {
                        var condition = new Object();
                        condition.value = list[i].conditionId;
                        condition.name = list[i].conditionName;
                        conditionList.push(condition);
                    }
                    xmSelect.render({
                        el: '#conditionSelect',
                        data: conditionList
                    })
                } else {
                    layer.msg("查询条件失败！" + data.data);
                }
            },
            error: function () {
                layer.msg("查询条件失败！");
            }
        });
    });

    function condition() {
        layui.use(['jquery', 'layer'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            var formData = new FormData();
            var file = document.getElementById("file").files[0];
            formData.append("file", file);
            var conditionName = $("#conditionName").val();
            var info = JSON.stringify({
                "conditionName": conditionName,
                "paramsType": $("#paramsType").val().split(","),
                "fieldType": $("#fieldType").val().split(","),
                "templateName": $("#templateName").val(),
                "templateMethodName": $("#templateMethodName").val(),
                "judgeContent": $("#judgeContent").val(),
                "preContent": $("#preContent").val()
            });
            //这里包装 可以直接转换成对象
            formData.append('json', new Blob([info], {type: "application/json"}));
            $.ajax({
                url: "/rule/addCondition",
                type: "POST",
                dataType: "json",
                data: formData,
                processData: false,//用于对data参数进行序列化处理 这里必须false
                contentType: false, //必须
                success: function (data) {
                    if (data.status == 10000) {
                        layer.msg("条件添加成功！");
                    } else {
                        layer.msg("条件添加失败！" + data.data);
                    }
                },
                error: function () {
                    layer.msg("条件添加失败！");
                }
            });
        });
    }

    function addRule() {
        layui.use(['jquery', 'layer'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            //这里包装 可以直接转换成对象
            var conditionSelect = xmSelect.get("#conditionSelect", true);
            $.ajax({
                url: "/rule/addRule",
                type: "POST",
                data: JSON.stringify({
                    "ruleName": $("#ruleName").val(),
                    "templateName": $("#templateName2").val(),
                    "templateMethodName": $("#templateMethodName2").val(),
                    "conditionIds": conditionSelect.getValue("valueStr"),
                    "returnType": $("#returnType").val(),
                    "hitCount": $("#hitCount").val(),
                    "hitContent": $("#hitContent").val()
                }),
                contentType: "application/json;charset=utf-8", //必须
                success: function (data) {
                    if (data.status == 10000) {
                        layer.msg("规则添加成功！");
                    } else {
                        layer.msg("规则添加失败！" + data.data);
                    }
                },
                error: function () {
                    layer.msg("规则添加失败！");
                }
            });
        });
    }

    function ruleRun() {
        layui.use(['jquery', 'layer'], function () {
            var $ = layui.jquery;
            var layer = layui.layer;
            var params = new Map();
            for (i = 1; i <= lastSize; i++) {
                var key = $("#runParamsType" + i).val();
                if (key != null && key != "") {
                    params.set(key, $("#runParamsValue" + i).val());
                }
            }
            //这里包装 可以直接转换成对象
            $.ajax({
                url: "/rule/run",
                type: "POST",
                data: JSON.stringify([{
                    "ruleName": $("#ruleName2").val(),
                    "templateMethodName": $("#templateMethodName3").val(),
                    "params": params
                }]),
                contentType: "application/json;charset=utf-8", //必须
                success: function (data) {
                    if (data.status == 10000) {
                        layer.alert("规则执行成功！\r执行结果：" + JSON.stringify(data.data[0]));
                    } else {
                        layer.msg("规则执行失败！" + data.data);
                    }
                },
                error: function () {
                    layer.msg("规则执行失败！");
                }
            });
        });
    }

    function addInput() {
        layui.use(['jquery', 'layer'], function () {
            var $ = layui.jquery;
            var index = lastSize + 1;
            var html = "<div class=\"layui-form-item\"><label class=\"layui-form-label\">执行规则参数类型" + index + "：</label>\n" +
                "    <div class=\"layui-input-inline\">\n" +
                "        <input type=\"text\" id=\"runParamsType" + index + "\" name=\"runParamsType" + index + "\" lay-verify=\"title\"\n" +
                "               autocomplete=\"off\" class=\"layui-input\">\n" +
                "    </div>\n" +
                "    <label class=\"layui-form-label\">执行规则参数值" + index + "：</label>\n" +
                "    <div class=\"layui-input-inline\">\n" +
                "        <input type=\"text\" id=\"runParamsValue" + index + "\" name=\"runParamsValue" + index + "\" lay-verify=\"title\"\n" +
                "               autocomplete=\"off\" class=\"layui-input\">\n" +
                "    </div></div>";
            $("#runParams").append(html);
            lastSize++;
        });
    }
</script>
</body>
</html>
